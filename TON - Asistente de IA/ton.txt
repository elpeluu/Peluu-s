// --- 1. CONFIGURACI√ìN ---
const GEMINI_API_KEY = "****"; 
const WHATSAPP_TOKEN = "****"; 
const PHONE_NUMBER_ID = "***"; 
const VERIFY_TOKEN = "****"; 
const SPREADSHEET_ID = "****";

// --- 2. RECEPCI√ìN Y ORQUESTACI√ìN ---
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    if (!data.entry || !data.entry[0].changes[0].value.messages) return ContentService.createTextOutput("OK");

    const msg = data.entry[0].changes[0].value.messages[0];
    const from = msg.from; 
    const text = msg.text.body; 
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const zonaHoraria = ss.getSpreadsheetTimeZone();
    
    // --- LEER CONTEXTO (Libro Actual) ---
    const hojaLA = ss.getSheetByName("Libro Actual");
    const datosColumnaA = hojaLA.getRange("A:A").getValues();
    const ultimaFilaConDatos = datosColumnaA.filter(String).length; 
    
    // Datos de hoy
    const fechaHoyObj = new Date();
    const fechaHoyTexto = Utilities.formatDate(fechaHoyObj, zonaHoraria, "dd/MM/yyyy");

    let estadoActual = {
      titulo: "Ninguno",
      inicio: 0,
      fin: 0,
      totalLibro: 0,
      ultimoMarcador: 0,
      ultimaFechaTexto: "N/A",
      fila: ultimaFilaConDatos,
      fechaHoyTexto: fechaHoyTexto
    };

    if (ultimaFilaConDatos > 1) {
      const filaDatos = hojaLA.getRange(ultimaFilaConDatos, 1, 1, 7).getValues()[0];
      const fUltima = filaDatos[5] ? new Date(filaDatos[5]) : null;
      estadoActual = {
        titulo: filaDatos[0],
        inicio: filaDatos[1],
        fin: filaDatos[2],
        totalLibro: filaDatos[3],
        ultimoMarcador: Number(filaDatos[6]), 
        ultimaFechaTexto: fUltima ? Utilities.formatDate(fUltima, zonaHoraria, "dd/MM/yyyy") : "N/A",
        fila: ultimaFilaConDatos,
        fechaHoyTexto: fechaHoyTexto
      };
    }

    // --- LLAMADA AL CEREBRO ---
    const respuestaIA = preguntarGemini(text, estadoActual);
    
    // --- DECISI√ìN: ¬øQU√â HACEMOS? ---

    // CASO A: ES SOLO CHARLA (Recomendaciones, dudas...)
    if (respuestaIA.tipoAccion === "chat") {
        enviarWhatsApp(from, respuestaIA.mensajeChat);
        return ContentService.createTextOutput("OK");
    }

    // CASO B: ES UN REGISTRO DE LECTURA
    if (respuestaIA.tipoAccion === "registro" && respuestaIA.fechaObjetivo) {
      
      const fechaObjStr = respuestaIA.fechaObjetivo.replace(/-/g, "/"); 
      let filaDestino = -1;
      let marcadorAnterior = 0; 
      let acumuladoDia = 0; 

      // 1. Buscar si la fecha ya existe
      if (ultimaFilaConDatos > 1) {
        const rangoFechas = hojaLA.getRange(2, 6, ultimaFilaConDatos - 1, 1).getValues();
        for (let i = 0; i < rangoFechas.length; i++) {
          const f = rangoFechas[i][0] ? Utilities.formatDate(new Date(rangoFechas[i][0]), zonaHoraria, "dd/MM/yyyy") : "";
          if (f === fechaObjStr) {
            filaDestino = i + 2; 
            marcadorAnterior = Number(hojaLA.getRange(filaDestino, 7).getValue());
            break;
          }
        }
      }

      if (filaDestino !== -1) {
        // ACTUALIZAR (Ya existe fecha)
        let nuevoValor = respuestaIA.nuevoMarcador;
        if (respuestaIA.esDelta) {
             nuevoValor = marcadorAnterior + respuestaIA.cantidadDelta;
        }
        hojaLA.getRange(filaDestino, 7).setValue(nuevoValor);
        
        let valorFilaAnterior = estadoActual.inicio;
        if (filaDestino > 2) valorFilaAnterior = Number(hojaLA.getRange(filaDestino - 1, 7).getValue());
        acumuladoDia = nuevoValor - valorFilaAnterior;
        marcadorAnterior = valorFilaAnterior;

      } else {
        // NUEVA FILA (Hueco o d√≠a nuevo)
        const nuevaFila = ultimaFilaConDatos + 1;
        
        // Escribir datos (A-D)
        hojaLA.getRange(nuevaFila, 1, 1, 4).setValues([[
          estadoActual.titulo, estadoActual.inicio, estadoActual.fin, estadoActual.totalLibro
        ]]);
        
        // Escribir Fecha y Marcador (F-G)
        const partes = fechaObjStr.split("/");
        const fechaDate = new Date(partes[2], partes[1] - 1, partes[0]);
        let valorFinal = respuestaIA.nuevoMarcador;
        
        hojaLA.getRange(nuevaFila, 6, 1, 2).setValues([[fechaDate, valorFinal]]);
        
        // ORDENAR (Crucial para que las f√≥rmulas funcionen)
        const rangoSort = hojaLA.getRange(2, 1, nuevaFila - 1, 9);
        rangoSort.sort({column: 6, ascending: true});
        
        // Acumulado simplificado para el reporte
        acumuladoDia = valorFinal - estadoActual.ultimoMarcador; 
        if (acumuladoDia < 0) acumuladoDia = respuestaIA.cantidadDelta || 0; 
      }

      const mensajeFinal = `¬°Hola Peluu! Apuntado.\n\nüìä *Ficha Actualizada:*\nüìñ *Libro:* ${estadoActual.titulo}\nüìÖ *Fecha:* ${respuestaIA.fechaObjetivo}\nüìà *Acumulado:* ${acumuladoDia > 0 ? acumuladoDia : "Ajuste"} p√°gs.\nüîñ *Avance:* ${estadoActual.ultimoMarcador} ‚û° ${respuestaIA.nuevoMarcador}`;
      enviarWhatsApp(from, mensajeFinal);

    } else {
      enviarWhatsApp(from, "No entend√≠ si era una lectura o una pregunta.");
    }

  } catch (err) { console.error("Error: " + err.message); }
  return ContentService.createTextOutput("OK");
}

// --- 3. CEREBRO GEMINI (MODO DUAL) ---
function preguntarGemini(mensajeUsuario, estado) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  
  const promptSistema = `
  Eres TON, asistente de lectura.
  DATOS: Libro: ${estado.titulo}, P√°g Actual: ${estado.ultimoMarcador}, Hoy: ${estado.fechaHoyTexto}.
  
  TU TAREA: Clasifica el mensaje en una de dos acciones.
  
  ACCI√ìN 1: "registro"
  - Si el usuario reporta progreso (ej: "le√≠ 10 p√°ginas", "ayer avanc√©", "voy por la 100").
  - Calcula los n√∫meros.
  
  ACCI√ìN 2: "chat"
  - Si el usuario pregunta algo, pide recomendaci√≥n o saluda (ej: "recomi√©ndame un libro", "¬øcu√°nto me queda?", "hola").
  - Escribe una respuesta √∫til y breve en "mensajeChat".
  
  FORMATO JSON OBLIGATORIO:
  {
    "tipoAccion": "registro" | "chat",
    "fechaObjetivo": "dd/MM/yyyy" (solo si es registro),
    "nuevoMarcador": int (solo si es registro),
    "esDelta": boolean (solo si es registro),
    "cantidadDelta": int (solo si es registro),
    "mensajeChat": "Texto de respuesta..." (solo si es chat)
  }
  `;

  const payload = {
    "system_instruction": { "parts": [{ "text": promptSistema }] },
    "contents": [{ "parts": [{ "text": mensajeUsuario }] }],
    "generationConfig": { "responseMimeType": "application/json" }
  };
  
  try {
    const res = UrlFetchApp.fetch(url, { 
      "method": "post", "contentType": "application/json", "payload": JSON.stringify(payload), "muteHttpExceptions": true 
    });
    const json = JSON.parse(res.getContentText());
    if (json.candidates) return JSON.parse(json.candidates[0].content.parts[0].text);
  } catch (e) {
    return { "tipoAccion": "error" };
  }
  return { "tipoAccion": "error" };
}

function enviarWhatsApp(telefono, texto) {
  if (!texto) return;
  const payload = { "messaging_product": "whatsapp", "to": telefono, "type": "text", "text": { "body": texto } };
  try {
    UrlFetchApp.fetch(`https://graph.facebook.com/v21.0/${PHONE_NUMBER_ID}/messages`, {
      "method": "post", "contentType": "application/json",
      "headers": { "Authorization": "Bearer " + WHATSAPP_TOKEN },
      "payload": JSON.stringify(payload), "muteHttpExceptions": true 
    });
  } catch (e) {}
}
